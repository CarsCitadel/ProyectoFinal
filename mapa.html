<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/Mapa.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="icon" href="/icon/reserva.png">
        <!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.min.css" rel="stylesheet">
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.min.js"></script>


    <title>Reservas</title>
  </head>
  <body class="Mapa">
    <a class="nav-item" href="/index.php"> <img class="icon" src="/icon/casa-icono-silueta.png" width="23">Inicio</a>
  <!--Fin navbar-->
    <div class="Costos">
      <label class="anuncio"> Disponibilidad De Nuestro Parqueadero </label>
      <select id="vehicleType" data-id="movie">
        <option id="movie" data-id="movie" value="1500">Moto</option>
        <option id="movie" data-id="movie" value="3600">Carro</option>
      </select>
    </div>

    <ul class="showcase">
      <li>
        <div class="Espacio motos"></div>
        <small>Motos</small>
      </li>
      <li>
        <div class="Espacio carros"></div>
        <small>Carros</small>
      </li>
      <li>
        <div class="Espacio selected"></div>
        <small>Seleccionado</small>
      </li>
      <li>
        <div class="Espacio sold"></div>
        <small>Presencial</small>
      </li>
    </ul>
      <div class="container_Mapa">
        <div class="parking-rows">
          <div class="row">
            <div class="Espacio motos" data-id="A1">A1</div>
            <div class="Espacio motos" data-id="A2">A2</div>
            <div class="Espacio carros" data-id="A3">A3</div>
            <div class="Espacio carros" data-id="A4">A4</div>
            <div class="Espacio sold" data-id="A5">A5</div>
            <div class="Espacio sold" data-id="A6">A6</div>
            <div class="Espacio sold" data-id="A7">A7</div>
            <div class="Espacio sold" data-id="A8">A8</div>
          </div>
          <div class="row">
            <div class="Espacio motos" data-id="B1">B1</div>
            <div class="Espacio motos"  data-id="B2">B2</div>
            <div class="Espacio carros" data-id="B3">B3</div>
            <div class="Espacio carros" data-id="B4">B4</div>
            <div class="Espacio sold" data-id="B5">B5</div>
            <div class="Espacio sold" data-id="B6">B6</div>
            <div class="Espacio sold" data-id="B7">B7</div>
            <div class="Espacio sold" data-id="B8">B8</div>
          </div>

          <div class="row">
            <div class="Espacio motos" data-id="C1">C1</div>
            <div class="Espacio motos" data-id="C2">C2</div>
            <div class="Espacio carros" data-id="C3">C3</div>
            <div class="Espacio carros" data-id="C4">C4</div>
            <div class="Espacio sold" data-id="C5">C5</div>
            <div class="Espacio sold" data-id="C6">C6</div>
            <div class="Espacio sold" data-id="C7">C7</div>
            <div class="Espacio sold" data-id="C8">C8</div>
          </div>
          <div class="row">
            <div class="Espacio motos" data-id="D1">D1</div>
            <div class="Espacio motos" data-id="D2">D2</div>
            <div class="Espacio carros" data-id="D3">D3</div>
            <div class="Espacio carros" data-id="D4">D4</div>
            <div class="Espacio sold" data-id="D5">D5</div>
            <div class="Espacio sold" data-id="D6">D6</div>
            <div class="Espacio sold" data-id="D7">D7</div>
            <div class="Espacio sold" data-id="D8">D8</div>
          </div>
          <div class="row">
            <div class="Espacio motos" data-id="E1">E1</div>
            <div class="Espacio motos" data-id="E2">E2</div>
            <div class="Espacio carros" data-id="E3">E3</div>
            <div class="Espacio carros" data-id="E4">E4</div>
            <div class="Espacio sold" data-id="E5">E5</div>
            <div class="Espacio sold" data-id="E6">E6</div>
            <div class="Espacio sold" data-id="E7">E7</div>
            <div class="Espacio sold" data-id="E8">E8</div>
          </div>
          <div class="row">
            <div class="Espacio motos" data-id="F1">F1</div>
            <div class="Espacio motos" data-id="F2">F2</div>
            <div class="Espacio carros" data-id="F3">F3</div>
            <div class="Espacio carros" data-id="F4">F4</div>
            <div class="Espacio sold" data-id="F5">F5</div>
            <div class="Espacio sold" data-id="F6">F6</div>
            <div class="Espacio sold" data-id="F7">F7</div>
            <div class="Espacio sold" data-id="F8">F8</div>
          </div>
        </div>
      </div>
    <p class="text">
      Haz Seleccionado <span id="count">0</span> Espacio Para Reservar Por Un Costo De <span
        id="total"data-id="precio"
         >0</span
      >
    </p>

      <section>
        <img src="/img/" alt="" class="fondo FondoPerfil" >

      
              <div class="formularioReserva">
                  <form class="form-reserva" id="form_reserva">
                      <h2>Reserva</h2>
                      
                      <div class="containerDigiteNombre">
                          <label for="Nombre">Digite su nombre</label>
                          <input name="Nombre" type="text" id="Nombre" class="box" required>
                      </div>
              
                      <div class="form-group">
                          <label for="Placa">Digite su placa</label>
                          <input name="Placa" type="text" id="Placa" class="box" required>
                      </div>
              
                      <div class="form-group">
                          <label for="Vehiculo">Tipo de vehículo</label>
                          <input name="Vehiculo" type="text" id="Vehiculo" class="box" readonly required>
                      </div>
              
                      <div class="form-group">
                          <label for="Modelo">Modelo</label>
                          <input name="Modelo" type="text" id="Modelo" class="box" required>
                      </div>
              
                      <div class="form-group">
                          <label for="Espacio">Espacio</label>
                          <input name="Id_Espacio" type="text" id="Espacio" class="box" readonly required>
                      </div>
              
                      <div class="form-group">
                          <label for="Hora_Entrada">Hora y fecha entrada</label>
                          <input name="Hora_Entrada" type="datetime-local" id="Hora_Entrada" class="box" required>
                      </div>
              
                      <div class="form-group">
                          <label for="Hora_Salida">Hora y fecha salida</label>
                          <input name="Hora_Salida" type="datetime-local" id="Hora_Salida" class="box" required>
                      </div>
              
                      <div class="form-group">
                          <label for="Precio_Hora">Precio por hora</label>
                          <input name="Precio_Hora" type="text" id="Precio_Hora" class="box" readonly required>
                      </div>
              
                      <div class="form-group">
                          <label for="Precio">Su precio es:</label>
                          <input name="Precio" type="text" id="Precio" class="box" readonly required>
                      </div>
              
                      <h2>Pago</h2>
              
                      <div class="form-group">
                          <label for="Metodo">Método de Pago</label>
                          <select name="Metodo" id="Metodo" class="box" required>
                              <option value="Tarjeta">Tarjeta</option>
                              <option value="Transferencia">Transferencia</option>
                              <option value="Efectivo">Efectivo</option>
                          </select>
                      </div>
              
                      <div class="form-group">
                          <label for="Numero_cuenta">Número de cuenta</label>
                          <input name="Numero_cuenta" type="text" id="Numero_cuenta" class="box" required>
                      </div>
              
                      <div class="monto-container">
                          <label for="Monto">Monto</label>
                          <input name="Monto" type="text" id="Monto" class="box" required>
                          <input type="submit" value="Reservar" class="submit" id="submit">
                      </div>
                  </form>
              </div> 
      </section>
  
      <script src="Mapa.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    

  <script>
      document.getElementById('form_reserva').addEventListener('submit', function (e) {
  e.preventDefault(); // Prevenir el envío estándar del formulario

  // Crear el FormData a partir del formulario
  const form = e.target;
  const formData = new FormData(form);

  fetch('/php/Mapa.php', {
    method: 'POST',
    body: formData
  })
    .then(response => {
      if (!response.ok) throw new Error('Error en la respuesta del servidor');
      return response.json(); // Esperar JSON
    })
    .then(result => {
      if (result.success) {
        // Mostrar el mensaje de éxito y esperar a que el usuario lo cierre
        Swal.fire({
          title: '¡Reserva exitosa!',
          text: result.message,
          icon: 'success',
          confirmButtonText: 'Aceptar'
        }).then(() => {
          // Después de que el usuario cierre el mensaje de éxito, preguntar si desea descargar la factura
          Swal.fire({
            title: '¿Deseas descargar la factura?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí',
            cancelButtonText: 'No'
          }).then((choice) => {
            if (choice.isConfirmed) {
              // Si el usuario acepta, crear y descargar el PDF
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF();

              // Encabezado de la factura
            pdf.setFontSize(16);
            pdf.setTextColor(0, 0, 0);
            pdf.text("Factura de Parqueadero", 105, 20, null, null, "center");

            // Logo de la empresa (si tienes un logo, lo puedes agregar como base64 o URL pública)
            const logoUrl = "/img/logo Parqueadero.png"; // Reemplaza por tu imagen
            pdf.addImage(logoUrl, "PNG", 10, 10, 30, 30);

            // Detalles de la reserva (estructura básica)
            pdf.setFontSize(12);
            pdf.setTextColor(50, 50, 50);
            pdf.text("Fecha de emisión: ", 10, 50);
            pdf.text(new Date().toLocaleDateString(), 60, 50);

            pdf.text("Nombre:", 10, 60);
            pdf.text(result.Nombre, 50, 60);
            pdf.text("Placa:", 10, 70);
            pdf.text(result.Placa, 50, 70);
            pdf.text("Vehículo:", 10, 80);
            pdf.text(result.Vehiculo, 50, 80);
            pdf.text("Espacio:", 10, 90);
            pdf.text(result.Id_Espacio, 50, 90);
            pdf.text("Hora Entrada:", 10, 100);
            pdf.text(result.Hora_Entrada, 50, 100);
            pdf.text("Hora Salida:", 10, 110);
            pdf.text(result.Hora_Salida, 50, 110);

            // Línea separadora
            pdf.setDrawColor(100, 100, 100);
            pdf.line(10, 120, 200, 120);

            // Resumen de los costos
            pdf.setFontSize(12);
            pdf.text("Resumen de Cargos", 10, 130);
            pdf.setFontSize(10);
            pdf.text("Precio Total: $", 10, 140);
            pdf.text(`${result.Precio}`, 50, 140);

            // Pie de página con mensaje de agradecimiento
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text("Gracias por utilizar nuestro servicio de parqueadero.", 105, 170, null, null, "center");
            pdf.text("Para más información, contáctanos en soporte@carcitadel.com.", 105, 180, null, null, "center");

            // Descargar el PDF
            pdf.save("factura_parqueadero.pdf");
            }
          });
        });

        // Reiniciar el formulario después de la reserva exitosa
        form.reset();
      } else {
        // Si la reserva falla, mostrar error con SweetAlert
        Swal.fire({
          title: 'Error',
          text: result.error,
          icon: 'error',
          confirmButtonText: 'Aceptar'
        });
      }
    })
    .catch(error => {
      console.error('Error al procesar la solicitud:', error);
      // Mostrar mensaje de error general con SweetAlert
      Swal.fire({
        title: 'Hubo un problema',
        text: 'Hubo un problema al procesar la solicitud.',
        icon: 'error',
        confirmButtonText: 'Aceptar'
      });
    });
});

  </script>
    
  <script>
      document.getElementById('Hora_Entrada').addEventListener('change', actualizarPrecio);
      document.getElementById('Hora_Salida').addEventListener('change', actualizarPrecio);
      document.getElementById('vehicleType').addEventListener('change', actualizarPrecio);

      function actualizarPrecio() {
        const horaEntrada = document.getElementById('Hora_Entrada').value;
        const horaSalida = document.getElementById('Hora_Salida').value;
        const precioPorHora = parseFloat(document.getElementById('vehicleType').value);
      
        if (horaEntrada && horaSalida) {
          const diferencia = calcularDiferenciaHoras(horaEntrada, horaSalida);
          const totalPrecio = diferencia * precioPorHora;
          document.getElementById('Precio').value = totalPrecio.toFixed(2); // Mostrar el precio calculado
          document.getElementById('Monto').value = totalPrecio.toFixed(2); // Mostrar el precio calculado
        }
      }

      function calcularDiferenciaHoras(horaEntrada, horaSalida) {
        const entrada = new Date(horaEntrada);
        const salida = new Date(horaSalida);
        const diferencia = (salida - entrada) / 1000 / 60 / 60; // Diferencia en horas
        return diferencia > 0 ? diferencia : 0;
      }
 
  </script>
</body>
</html>